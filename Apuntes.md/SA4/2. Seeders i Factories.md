
# ğŸŒ±ğŸ­ 2. Seeders i Factories (Estadis i Equips)

En aquest apartat treballarem amb:

- **Seeders** â†’ omplir la BBDD amb dades dâ€™exemple.
- **Factories** â†’ generar dades falses (faker) de manera automÃ tica.
- **DatabaseSeeder** â†’ el seeder â€œprincipalâ€ que crida la resta.

---

## 2.1. Crear Seeders i Factories

En aquest projecte utilitzem Docker + Makefile. 
Creem els seeders i factories amb:

```bash
make artisan CMD="make:seeder EquipsSeeder"
make artisan CMD="make:seeder EstadisSeeder"
make artisan CMD="make:factory EquipFactory"
make artisan CMD="make:factory EstadiFactory"
```

Aquests fitxers es creen a:

- `database/seeders/EquipsSeeder.php`
- `database/seeders/EstadisSeeder.php`
- `database/factories/EquipFactory.php`
- `database/factories/EstadiFactory.php`

---

## 2.2. Models implicats (resum)

Ens assegurem que els models tenen `HasFactory` i les relacions.

### `app/Models/Estadi.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

/**
 * MODEL ESTADI
 */
class Estadi extends Model
{
    use HasFactory;

    protected $fillable = ['nom', 'capacitat'];

    /**
     * Un estadi tÃ© molts equips
     */
    public function equips()
    {
        return $this->hasMany(Equip::class);
    }
}
```

### `app/Models/Equip.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Database\Factories\EquipFactory;

/**
 * Model EQUIP
 */
class Equip extends Model
{
    use HasFactory;

    protected $fillable = ['nom', 'estadi_id', 'titols'];

    /**
     * Un equip pertany a un estadi
     */
    public function estadi()
    {
        return $this->belongsTo(Estadi::class);
    }

    /**
     * (Opcional) relaciÃ³ amb un usuari manager
     */
    public function manager()
    {
        return $this->hasOne(User::class);
    }

    /**
     * Enllacem explÃ­citament amb la factory
     */
    protected static function newFactory()
    {
        return EquipFactory::new();
    }
}
```

---

## 2.3. Completar les Factories

### `database/factories/EstadiFactory.php`

```php
<?php

namespace Database\Factories;

use App\Models\Estadi;
use Illuminate\Database\Eloquent\Factories\Factory;

/**
 * @extends Factory<\App\Models\Estadi>
 */
class EstadiFactory extends Factory
{
    /**
     * Model associat a la factory
     *
     * @var string
     */
    protected $model = Estadi::class;

    /**
     * Estat per defecte
     */
    public function definition(): array
    {
        return [
            'nom'       => $this->faker->unique()->city.' Stadium',
            'capacitat' => $this->faker->numberBetween(10000, 100000),
        ];
    }
}
```

### `database/factories/EquipFactory.php`

```php
<?php

namespace Database\Factories;

use App\Models\Equip;
use App\Models\Estadi;
use Illuminate\Database\Eloquent\Factories\Factory;

/**
 * @extends Factory<\App\Models\Equip>
 */
class EquipFactory extends Factory
{
    /**
     * Model associat a la factory
     *
     * @var string
     */
    protected $model = Equip::class;

    /**
     * Estat per defecte
     */
    public function definition(): array
    {
        return [
            'nom'       => $this->faker->unique()->company,
            'titols'    => $this->faker->numberBetween(0, 50),
            // CrearÃ  tambÃ© un Estadi associat si no en passem cap
            'estadi_id' => Estadi::factory(),
            // 'escut' => 'escuts/dummy.png',
        ];
    }
}
```

---

## 2.4. Completar els Seeders

### `database/seeders/EstadisSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\Estadi;
use Illuminate\Database\Seeder;

class EstadisSeeder extends Seeder
{
    public function run(): void
    {
        Estadi::create(['nom' => 'Camp Nou',            'capacitat' => 99000]);
        Estadi::create(['nom' => 'Wanda Metropolitano', 'capacitat' => 68000]);
        Estadi::create(['nom' => 'Santiago BernabÃ©u',   'capacitat' => 81000]);

        // Opcional: per comprovar que s'han creat
        dump('EstadisSeeder - desprÃ©s de crear:', Estadi::count());
    }
}
```

### `database/seeders/EquipsSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\Equip;
use App\Models\Estadi;
use Illuminate\Database\Seeder;

class EquipsSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Opcional: missatge de depuraciÃ³
        dump('EquipsSeeder: abans de crear', [
            'estadis' => Estadi::count(),
            'equips'  => Equip::count(),
        ]);

        // Assegurem que els 3 estadis principals existeixen
        $campNou = Estadi::firstOrCreate(
            ['nom' => 'Camp Nou'],
            ['capacitat' => 99000]
        );

        $wanda = Estadi::firstOrCreate(
            ['nom' => 'Wanda Metropolitano'],
            ['capacitat' => 68000]
        );

        $bernabeu = Estadi::firstOrCreate(
            ['nom' => 'Santiago BernabÃ©u'],
            ['capacitat' => 81000]
        );

        // Crear equips â€œa mÃ â€ amb relaciÃ³
        $campNou->equips()->firstOrCreate(
            ['nom' => 'BarÃ§a FemenÃ­'],
            ['titols' => 30]
        );

        $wanda->equips()->firstOrCreate(
            ['nom' => 'AtlÃ¨tic de Madrid'],
            ['titols' => 10]
        );

        $bernabeu->equips()->firstOrCreate(
            ['nom' => 'Real Madrid FemenÃ­'],
            ['titols' => 5]
        );

        // Crear 10 equips mÃ©s usant la factory
        Equip::factory()->count(10)->create();

        // Opcional: comprovar resultats
        dump('EquipsSeeder: desprÃ©s de crear', [
            'estadis' => Estadi::count(),
            'equips'  => Equip::count(),
        ]);
    }
}
```

---

## 2.5. Completar el `DatabaseSeeder`

Aquest Ã©s el seeder â€œprincipalâ€ que Laravel executa quan fem `db:seed` o `migrate:fresh --seed`.

### `database/seeders/DatabaseSeeder.php`

```php
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        // Des d'acÃ­ cridem la resta de seeders
        $this->call([
            EstadisSeeder::class,
            EquipsSeeder::class,
        ]);

        // Opcional: per veure que acaba
        dump('DatabaseSeeder: FIN');
    }
}
```

> ğŸ”´ Nota important:
> 
> En la plantilla original de Laravel tambÃ© es creava un usuari de prova amb `test@example.com`.
> AixÃ² pot donar problemes de clau Ãºnica (`Duplicate entry`) si executes `db:seed` diverses vegades.
> Per a aquesta prÃ ctica **hem eliminat** la creaciÃ³ de lâ€™usuari per simplificar.

---

## 2.6. Executar els Seeders i Factories

### 2.6.1. Executar tots els seeders (via `DatabaseSeeder`)

```bash
make artisan CMD="db:seed"
```

AixÃ² executa:

1. `DatabaseSeeder::run()`
2. Que al seu torn crida:
   - `EstadisSeeder`
   - `EquipsSeeder`

### 2.6.2. Executar un seeder concret

Per exemple, nomÃ©s `EquipsSeeder`:

```bash
make artisan CMD="db:seed --class=EquipsSeeder"
```

Ãštil per a provar nomÃ©s una part sense tocar la resta.

### 2.6.3. `migrate:fresh --seed` (tot des de zero)

```bash
make artisan CMD="migrate:fresh --seed"
```

QuÃ¨ fa exactament?

1. **Dropping all tables** â†’ Esborra TOTES les taules de la base de dades.
2. **Running migrations** â†’ Torna a crear les taules des de les migracions.
3. **Seeding database** â†’ Executa `DatabaseSeeder` (i per tant `EstadisSeeder` i `EquipsSeeder`).

Ã‰s el â€œreset completâ€ ideal en desenvolupament: 
et deixa la BBDD neta i reomplida amb dades dâ€™exemple.

---

## 2.7. ComprovaciÃ³ amb Tinker (opcional perÃ² recomanable)

DesprÃ©s de fer `migrate:fresh --seed`, podem comprovar:

```bash
make artisan CMD="tinker"
```

Dins de Tinker:

```php
>>> \App\Models\Estadi::count();        // quants estadis hi ha?
>>> \App\Models\Equip::count();         // quants equips hi ha?
>>> \App\Models\Estadi::with('equips')->get(); // estadis + equips relacionats
```

Si tot estÃ  correcte, veureu:

- 3 estadis â€œfamososâ€ (Camp Nou, Wanda, BernabÃ©u)
- + uns quants estadis extra creats per les factories
- equips creats a mÃ  + equips creats per `EquipFactory`

---

## 2.8. Errors tÃ­pics que hem evitat amb aquests canvis

- âŒ **No cridar els seeders des de `DatabaseSeeder`** 
  â†’ `db:seed` no faria res. 
  âœ”ï¸ SoluciÃ³: afegir-los a `$this->call([...])`.

- âŒ **Duplicar usuaris de prova (`test@example.com`)** 
  â†’ error de `Duplicate entry` si es creava sempre el mateix usuari. 
  âœ”ï¸ SoluciÃ³: per a aquesta prÃ ctica, hem eliminat lâ€™usuari de prova.

- âŒ **Models sense `HasFactory` o sense relacions** 
  â†’ `Model::factory()` no existeix, o `$estadi->equips()` dÃ³na error. 
  âœ”ï¸ SoluciÃ³: afegir `use HasFactory;` i definir `equips()` / `estadi()` als models.

Amb aquest esquema, si seguiu els passos en ordre, 
`db:seed` i `migrate:fresh --seed` funcionaran sense errors ğŸ‰
