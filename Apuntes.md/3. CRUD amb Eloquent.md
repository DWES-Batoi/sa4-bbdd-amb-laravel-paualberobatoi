
# 3. âš™ï¸ CRUD amb Eloquent

En aquesta tercera part treballarem el **CRUD** per als nostres models `Estadi` i `Equip` utilitzant:

- **Controllers** (`EstadiController`, `EquipController`)
- **Rutes `Route::resource`**
- **Vistes Blade** (`index`, `create`, `show`, â€¦)
- **Components Blade** (`<x-estadi>`, `<x-equip>`)

---

## 3.1. QuÃ¨ Ã©s CRUD?

CRUD sÃ³n les operacions bÃ siques que fem amb una taula de la BBDD:

- **C â€“ Create** â†’ crear registres nous (formulari â€œNou estadiâ€, â€œNou equipâ€)
- **R â€“ Read** â†’ llegir/llistar registres (llistat dâ€™estadis, detall dâ€™un estadi)
- **U â€“ Update** â†’ actualitzar registres (formulari dâ€™ediciÃ³)
- **D â€“ Delete** â†’ esborrar registres

Laravel ens ajuda amb tot aixÃ² a travÃ©s dâ€™**Eloquent** (models) i de les rutes de tipus **`resource`**.

---

## 3.2. Crear els controllers

Primer creem els controllers amb el nostre Makefile (dins del projecte):

```bash
make artisan CMD="make:controller EquipController --resource"
make artisan CMD="make:controller EstadiController --resource"
```

Lâ€™opciÃ³ `--resource` crea automÃ ticament els mÃ¨todes del CRUD:

- `index()`  â†’ llistar
- `create()` â†’ mostrar formulari de creaciÃ³
- `store()`  â†’ guardar nou registre
- `show()`   â†’ mostrar un registre concret
- `edit()`   â†’ mostrar formulari dâ€™ediciÃ³
- `update()` â†’ actualitzar el registre
- `destroy()`â†’ esborrar el registre

### 3.2.1. `EstadiController`

Aquest Ã©s el controlador per a la gestiÃ³ dâ€™**estadis**:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Estadi;
use Illuminate\Http\Request;

class EstadiController extends Controller
{
    // GET /estadis
    public function index()
    {
        $estadis = Estadi::all();
        return view('estadis.index', compact('estadis'));
    }

    // GET /estadis/{estadi}
    public function show(Estadi $estadi)
    {
        return view('estadis.show', compact('estadi'));
    }

    // GET /estadis/create
    public function create()
    {
        return view('estadis.create');
    }

    // POST /estadis
    public function store(Request $request)
    {
        $estadi = new Estadi($request->all());
        $estadi->save();

        return redirect()
            ->route('estadis.index')
            ->with('success', 'Estadi afegit correctament!');
    }

    // GET /estadis/{estadi}/edit
    public function edit(Estadi $estadi)
    {
        return view('estadis.edit', compact('estadi'));
    }

    // PUT/PATCH /estadis/{estadi}
    public function update(Request $request, Estadi $estadi)
    {
        $estadi->update($request->all());

        return redirect()
            ->route('estadis.index')
            ->with('success', 'Estadi actualitzat correctament!');
    }

    // DELETE /estadis/{estadi}
    public function destroy(Estadi $estadi)
    {
        $estadi->delete();

        return redirect()
            ->route('estadis.index')
            ->with('success', 'Estadi esborrat correctament!');
    }
}
```

Per a aquesta prÃ ctica ens centrarem sobretot en:

- `index()` â†’ llistat dâ€™estadis 
- `create()` + `store()` â†’ formulari + alta 
- `show()` â†’ detall dâ€™un estadi

Els mÃ¨todes `edit()`, `update()` i `destroy()` queden preparats per completar-los mÃ©s endavant.

---

### 3.2.2. `EquipController` (avanÃ§at)

Aquest controlador utilitza **un servei `EquipService`** i tambÃ© **Form Requests** (`StoreEquipRequest`, `UpdateEquipRequest`):

```php
<?php

namespace App\Http\Controllers;

use App\Http\Requests\StoreEquipRequest;
use App\Http\Requests\UpdateEquipRequest;
use App\Models\Equip;
use App\Models\Estadi;
use App\Services\EquipService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Session;

class EquipController extends Controller
{
    public function __construct(private EquipService $servei) {}

    // GET /equips
    public function index()
    {
        return view('equips.index', ['equips' => $this->servei->llistar()]);
    }

    // GET /equips/create
    public function create()
    {
        $estadis = Estadi::all();
        return view('equips.create', compact('estadis'));
    }

    // POST /equips
    public function store(StoreEquipRequest $request)
    {
        $this->servei->guardar($request->validated());
        return redirect()->route('equips.index');
    }

    // GET /equips/{equip}
    public function show(Equip $equip)
    {
        return view('equips.show', compact('equip'));
    }

    // GET /equips/{equip}/edit
    public function edit(Equip $equip)
    {
        return view('equips.edit', compact('equip'));
    }

    // PUT /equips/{equip}
    public function update(UpdateEquipRequest $request, Equip $equip)
    {
        $this->servei->actualitzar($equip, $request->validated());
        return redirect()->route('equips.index')->with('ok', 'Equip actualitzat');
    }

    // DELETE /equips/{id}
    public function destroy($id)
    {
        $this->servei->eliminar($id);
        return redirect()->route('equips.index');
    }
}
```

> ğŸ”´ **Molt important**
>
> En aquest punt del temari **encara no hem creat**:
> - la classe `App\Services\EquipService`
> - ni els `StoreEquipRequest` / `UpdateEquipRequest`
>
> Per tant, si proveu dâ€™entrar a `/equips` tal qual, Laravel donarÃ  un error del tipus:
> `Target class [App\Services\EquipService] does not exist`.
>
> En aquesta part ens centrarem sobretot en el CRUD dâ€™**Estadis**. 
> La part dâ€™**Equips** quedarÃ  preparada perÃ² es completarÃ  al capÃ­tol segÃ¼ent, on explicarem quÃ¨ Ã©s un *service* i com encapsular la lÃ²gica dâ€™Eloquent.

---

## 3.3. Rutes `Route::resource`

Les rutes del CRUD les definim a `routes/web.php`:

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\EstadiController;
use App\Http\Controllers\EquipController;

Route::get('/', function () {
    return redirect()->route('estadis.index');
});

Route::resource('/estadis', EstadiController::class);
Route::resource('/equips', EquipController::class);
```

`Route::resource()` crea automÃ ticament totes les rutes del CRUD. Per exemple, per a `estadis`:

| MÃ¨tode | URL                   | Nom de ruta        | MÃ¨tode del controller |
|--------|-----------------------|--------------------|------------------------|
| GET    | `/estadis`            | `estadis.index`    | `index()`              |
| GET    | `/estadis/create`     | `estadis.create`   | `create()`             |
| POST   | `/estadis`            | `estadis.store`    | `store()`              |
| GET    | `/estadis/{estadi}`   | `estadis.show`     | `show()`               |
| GET    | `/estadis/{estadi}/edit` | `estadis.edit`  | `edit()`               |
| PUT    | `/estadis/{estadi}`   | `estadis.update`   | `update()`             |
| DELETE | `/estadis/{estadi}`   | `estadis.destroy`  | `destroy()`            |

A les vistes, farem servir aquests noms de ruta amb `route('estadis.index')`, `route('estadis.show', $estadi->id)`, etc.

---

## 3.4. Layout i menÃº

El layout principal Ã©s `resources/views/layouts/app.blade.php`:

```blade
<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>@yield('title','Guia de futbol femenÃ­')</title>
  @vite(['resources/css/app.css' ])
</head>
<body class="font-sans bg-gray-100 text-gray-900">
  <header class="bg-blue-800 text-white p-4">
    @include('partials.menu')
  </header>
  <main class="container mx-auto p-6">
    @yield('content')
  </main>
  <footer class="bg-blue-800 text-white text-center p-4">
    <p>&copy; 2025 Guia de Futbol FemenÃ­</p>
  </footer>
</body>
</html>
```

El menÃº el tenim a `resources/views/partials/menu.blade.php`:

```blade
<nav>
  <ul class="flex space-x-4">
    <li><a class="text-white hover:underline" href="/">Inici</a></li>

    {{-- Opcional: activarem l'enllaÃ§ d'equips quan el service estiga creat --}}
    {{-- <li><a class="text-white hover:underline" href="{{ route('equips.index') }}">Guia d'Equips</a></li> --}}

    <li><a class="text-white hover:underline" href="{{ route('estadis.index') }}">Llistat d'Estadis</a></li>
  </ul>
</nav>
```

> â„¹ï¸ Recorda: per comentar codi Blade que contÃ© `{{ ... }}` Ã©s millor usar 
> `{{-- ... --}}` i no `<!-- ... -->`, perquÃ¨ Blade segueix executant el codi dins dels comentaris HTML.

---

## 3.5. CRUD dâ€™Estadis amb vistes Blade

### 3.5.1. Llistat dâ€™estadis (`estadis.index`)

`resources/views/estadis/index.blade.php`:

```blade
@extends('layouts.app')
@section('title', "Guia d'Estadis")

@section('content')
<h1 class="text-3xl font-bold text-blue-800 mb-6">Guia d'Estadis</h1>

@if (session('success'))
  <div class="bg-green-100 text-green-700 p-2 mb-4">{{ session('success') }}</div>
@endif

<p class="mb-4">
  <a href="{{ route('estadis.create') }}" class="bg-blue-600 text-white px-3 py-2 rounded">
    Nou Estadi
  </a>
</p>

<table class="w-full border-collapse border border-gray-300">
  <thead class="bg-gray-200">
    <tr>
      <th class="border border-gray-300 p-2">Nom</th>
      <th class="border border-gray-300 p-2">Capacitat</th>
    </tr>
  </thead>
  <tbody>
  @foreach($estadis as $estadi)
    <tr class="hover:bg-gray-100">
      <td class="border border-gray-300 p-2">
        <a href="{{ route('estadis.show', $estadi->id) }}" class="text-blue-700 hover:underline">
          {{ $estadi->nom }}
        </a>
      </td>
      <td class="border border-gray-300 p-2">{{ $estadi->capacitat }}</td>
    </tr>
  @endforeach
  </tbody>
</table>
@endsection
```

Aquesta vista utilitza:

- `EstadiController@index` per a obtindre `$estadis`
- `route('estadis.show', $estadi->id)` per enllaÃ§ar al detall (operaciÃ³ **Read**)

---

### 3.5.2. Formulari de creaciÃ³ dâ€™estadis (`estadis.create`)

`resources/views/estadis/create.blade.php`:

```blade
@extends('layouts.app')
@section('title', 'Afegir nou estadi')

@section('content')
<h1 class="text-2xl font-bold mb-4">Afegir nou estadi</h1>

@if ($errors->any())
  <div class="bg-red-100 text-red-700 p-2 mb-4">
    <ul>
      @foreach ($errors->all() as $error)
        <li>{{ $error }}</li>
      @endforeach
    </ul>
  </div>
@endif

<form action="{{ route('estadis.store') }}" method="POST" class="space-y-4">
  @csrf

  <div>
    <label for="nom" class="block font-bold">Nom:</label>
    <input
      type="text"
      name="nom"
      id="nom"
      value="{{ old('nom') }}"
      class="border p-2 w-full"
    >
  </div>

  <div>
    <label for="capacitat" class="block font-bold">Capacitat:</label>
    <input
      type="text"
      name="capacitat"
      id="capacitat"
      value="{{ old('capacitat') }}"
      class="border p-2 w-full"
    >
  </div>

  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">
    Afegir
  </button>
</form>
@endsection
```

Aquesta vista envia el formulari a:

- `route('estadis.store')` â†’ mÃ¨tode `store()` del `EstadiController`
- OperaciÃ³ **Create** del CRUD.

---

### 3.5.3. Detall dâ€™un estadi (`estadis.show`) amb component `<x-estadi>`

`resources/views/estadis/show.blade.php`:

```blade
@extends('layouts.app')
@section('title', "Detall d'Estadi")

@section('content')
  <x-estadi
    :nom="$estadi->nom"
    :capacitat="$estadi->capacitat"
    :equips="$estadi->equips"
  />
@endsection
```

AcÃ­ utilitzem un **component Blade** `<x-estadi>` que encapsula la presentaciÃ³ del detall.

PerquÃ¨ funcione, hem creat el component a:

`resources/views/components/estadi.blade.php`:

```blade
@props([
    'nom',
    'capacitat',
    'equips' => collect(),  // per si no es passa res
])

<div class="estadi border rounded-lg shadow-md p-4 bg-white">
  <h2 class="text-xl font-bold text-blue-800">{{ $nom }}</h2>

  <p><strong>Capacitat:</strong> {{ $capacitat }}</p>

  <p>
    <strong>Equips:</strong>
    {{ $equips->count() }}
  </p>
</div>
```

El controlador (`EstadiController@show`) passa lâ€™objecte `$estadi`:

```php
public function show(Estadi $estadi)
{
    $estadi->load('equips'); // opcional: carrega tambÃ© els equips
    return view('estadis.show', compact('estadi'));
}
```

> ğŸ’¡ Aquesta Ã©s una forma neta de separar:
> - la **lÃ²gica** (controller + model)
> - de la **presentaciÃ³** (component Blade).

---

## 3.6. Vistes dâ€™Equips (preparades)

Tot i que el controlador dâ€™**Equips** depÃ¨n dâ€™un `EquipService` que encara no hem creat, les vistes ja estan preparades.

### 3.6.1. Formulari de creaciÃ³ dâ€™equips (`equips.create`)

`resources/views/equips/create.blade.php`:

```blade
@extends('layouts.app')
@section('title', 'Afegir nou equip')

@section('content')
<h1 class="text-2xl font-bold mb-4">Afegir nou equip</h1>

@if ($errors->any())
  <div class="bg-red-100 text-red-700 p-2 mb-4">
    <ul>
      @foreach ($errors->all() as $error) <li>{{ $error }}</li> @endforeach
    </ul>
  </div>
@endif

<form action="{{ route('equips.store') }}" method="POST" class="space-y-4">
  @csrf

  <div>
    <label for="nom" class="block font-bold">Nom:</label>
    <input type="text" name="nom" id="nom" value="{{ old('nom') }}" class="border p-2 w-full">
  </div>

  <div>
    <label for="estadi_id" class="block font-bold">Estadi:</label>
    <select name="estadi_id" id="estadi_id" class="border p-2 w-full">
      @foreach ($estadis as $estadi)
        <option value="{{ $estadi->id }}" {{ old('estadi_id') == $estadi->id ? 'selected' : '' }}>
          {{ $estadi->nom }}
        </option>
      @endforeach
    </select>
  </div>

  <div>
    <label for="titols" class="block font-bold">TÃ­tols:</label>
    <input type="number" name="titols" id="titols" value="{{ old('titols') }}" class="border p-2 w-full">
  </div>

  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Afegir</button>
</form>
@endsection
```

### 3.6.2. Llistat dâ€™equips (`equips.index`)

`resources/views/equips/index.blade.php`:

```blade
@extends('layouts.app')
@section('title', "Guia d'Equips")

@section('content')
<h1 class="text-3xl font-bold text-blue-800 mb-6">Guia d'Equips</h1>

@if (session('success'))
  <div class="bg-green-100 text-green-700 p-2 mb-4">{{ session('success') }}</div>
@endif

<p class="mb-4">
  <a href="{{ route('equips.create') }}" class="bg-blue-600 text-white px-3 py-2 rounded">
    Nou equip
  </a>
</p>

<table class="w-full border-collapse border border-gray-300">
  <thead class="bg-gray-200">
    <tr>
      <th class="border border-gray-300 p-2">Nom</th>
      <th class="border border-gray-300 p-2">Estadi</th>
      <th class="border border-gray-300 p-2">TÃ­tols</th>
    </tr>
  </thead>
  <tbody>
  @foreach($equips as $equip)
    <tr class="hover:bg-gray-100">
      <td class="border border-gray-300 p-2">
        <a href="{{ route('equips.show', $equip->id) }}" class="text-blue-700 hover:underline">
          {{ $equip->nom }}
        </a>
      </td>
      <td class="border border-gray-300 p-2">{{ $equip->estadi->nom }}</td>
      <td class="border border-gray-300 p-2">{{ $equip->titols }}</td>
    </tr>
  @endforeach
  </tbody>
</table>
@endsection
```

### 3.6.3. Detall dâ€™equip (`equips.show`) amb component `<x-equip>`

`resources/views/equips/show.blade.php`:

```blade
@extends('layouts.app')
@section('title', "Detall d'Equip")

@section('content')
  <x-equip
    :nom="$equip->nom"
    :estadi="$equip->estadi->nom"
    :titols="$equip->titols"
  />
@endsection
```

Component `resources/views/components/equip.blade.php`:

```blade
<div class="equip border rounded-lg shadow-md p-4 bg-white">
  <h2 class="text-xl font-bold text-blue-800">{{ $nom }}</h2>
  <p><strong>Estadi:</strong> {{ $estadi }}</p>
  <p><strong>TÃ­tols:</strong> {{ $titols }}</p>
</div>
```

De nou, separem:

- LÃ²gica â†’ controlador `EquipController` + model `Equip`
- PresentaciÃ³ â†’ component `<x-equip>`

---

## 3.7. QuÃ¨ Ã©s un *Service*? (vista molt rÃ pida)

En el codi dâ€™`EquipController` hem vist que sâ€™injecta un `EquipService`:

```php
public function __construct(private EquipService $servei) {}
```

I desprÃ©s sâ€™utilitza:

```php
$this->servei->llistar();
$this->servei->guardar(...);
$this->servei->actualitzar(...);
$this->servei->eliminar($id);
```

Un **service** Ã©s simplement **una classe PHP on concentrem la lÃ²gica de negoci** (consultes Eloquent, validacions extra, etc.) per:

- No carregar massa el controlador
- Poder reutilitzar la mateixa lÃ²gica des de diversos llocs
- Tindre el codi mÃ©s organitzat

Per exemple, un `EquipService` tÃ­pic podria tindre mÃ¨todes com:

- `llistar()` â†’ torna tots els equips amb el seu estadi
- `guardar(array $dades)` â†’ crea un equip nou
- `actualitzar(Equip $equip, array $dades)` â†’ fa lâ€™update
- `eliminar(int $id)` â†’ borra lâ€™equip

> ğŸ“Œ **De moment, no hem creat encara aquesta classe**.  
> Ho farem en el capÃ­tol segÃ¼ent. Per aixÃ², en aquest tema:
> - funcionen completament les rutes i vistes dâ€™**estadis**
> - la part dâ€™**equips** la deixem â€œpreparadaâ€ per a quan introduÃ¯m els *services* i els *Form Requests*.

---

Amb tot aÃ§Ã², ja tens:

- Un CRUD complet dâ€™**Estadis** amb Eloquent i vistes Blade
- Lâ€™estructura preparada per al CRUD dâ€™**Equips**
- I la base per al segÃ¼ent tema, on millorarem lâ€™organitzaciÃ³ amb *services* i *form requests*.
