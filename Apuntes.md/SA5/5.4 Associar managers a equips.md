# Pràctica 5.4 — Associar managers a equips (Laravel)

## 1) Migració: afegir `equip_id` a `users`

Crea la migració:

- `make artisan CMD="make:migration add_equip_id_to_users_table --table=users"`

### Codi recomanat de la migració

**database/migrations/2025_09_03_174708_add_team_id_to_users_table.php** (el nom pot dir `team`, però el camp és `equip_id`, cap problema)

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            // Forma “Laravel moderna” i més neta:
            $table->foreignId('equip_id')
                ->nullable()
                ->constrained('equips')
                ->nullOnDelete();
        });
    }

    public function down(): void    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropConstrainedForeignId('equip_id');
        });
    }
};
```

Aplica la migració:

- `make migrate`

---

## 2) Relació al model `User`

**app/Models/User.php**

⚠️ IMPORTANT: afegeix `role` i `equip_id` a `$fillable` (sinó, el seeder que farem endavant dona error).

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use HasFactory, Notifiable;

    protected $fillable = [
        'name',
        'email',
        'password',
        'role',
        'equip_id',
    ];

    protected $hidden = [
        'password',
        'remember_token',
    ];

    public function equip()
    {
        return $this->belongsTo(Equip::class, 'equip_id');
    }

    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }
}
```

---

## 3) Relació inversa al model `Equip`

**app/Models/Equip.php**

Pots deixar-ho com `hasOne`, i si vols assegurar que només et torna l’usuari manager, afegeix un `where`.

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Equip extends Model
{
    use HasFactory;

    protected $fillable = ['nom', 'estadi_id', 'titols', 'escut'];

    public function estadi()
    {
        return $this->belongsTo(Estadi::class);
    }

    public function manager()
    {
        return $this->hasOne(User::class, 'equip_id')
            ->where('role', 'manager');
    }
}
```

---

## 4) Seeder: crear 1 manager per equip i assignar-lo

### Seeder recomanat (evita duplicats)

**database/seeders/EquipsSeeder.php**

```php
<?php

namespace Database\Seeders;

use App\Models\Equip;
use App\Models\Estadi;
use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;

class EquipsSeeder extends Seeder
{
    public function run(): void
    {
        $estadi = Estadi::where('nom', 'Camp Nou')->first();
        $estadi->equips()->updateOrCreate(
            ['nom' => 'Barça Femení'],
            ['titols' => 30]
        );

        $estadi = Estadi::where('nom', 'Wanda Metropolitano')->first();
        $estadi->equips()->updateOrCreate(
            ['nom' => 'Atlètic de Madrid'],
            ['titols' => 10]
        );

        $estadi = Estadi::where('nom', 'Santiago Bernabéu')->first();
        $estadi->equips()->updateOrCreate(
            ['nom' => 'Real Madrid Femení'],
            ['titols' => 5]
        );

        // Si tens UNIQUE a equips.nom i la factory pot repetir noms, posa unique() a la factory
        Equip::factory()->count(10)->create();

        foreach (Equip::all() as $equip) {
            User::updateOrCreate(
                ['email' => $equip->id . '@manager.com'],
                [
                    'name' => 'Manager ' . $equip->nom,
                    'password' => Hash::make('1234'),
                    'role' => 'manager',
                    'equip_id' => $equip->id,
                ]
            );
        }
    }
}

```
**database/seeders/UserSeeder.php**

```
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;

class UserSeeder extends Seeder
{
    public function run(): void
    {
        User::updateOrCreate(
            ['email' => 'admin@example.com'],
            [
                'name' => 'Admin',
                'password' => Hash::make('1234'),
                'role' => 'administrador',
            ]
        );
    }
}
```

Executa els seeders:

- `make artisan CMD="db:seed"`
- o si tens un target de “netejar i repoblar”: `make fresh` *(php artisan migrate:fresh --seed)*

---



## 5) Comprovar ràpid (Tinker)

- Podem entrar en phpmyadmmin y revisar que cada user hi ha un equip_id

---

## Checklist (què ha de quedar fet)

- [x] Migració amb `equip_id` nullable + foreign key a `equips(id)` amb `SET NULL` en esborrar equip
- [x] Seeder crea equips i crea **1 manager per equip** amb `equip_id`
- [x] `User` té `belongsTo(Equip::class, 'equip_id')` i `$fillable` inclou `role` i `equip_id`
- [x] `Equip` té `hasOne(User::class, 'equip_id')` (opcional `where role=manager`)
