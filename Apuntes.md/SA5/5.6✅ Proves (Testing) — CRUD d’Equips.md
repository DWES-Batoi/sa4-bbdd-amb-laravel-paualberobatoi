# 6. ‚úÖ Proves (Testing) ‚Äî CRUD d‚ÄôEquips 

En aquest apartat configurarem l‚Äôentorn de **tests** i crearem proves **unit√†ries** (servei + repositori) i una **feature** (CRUD via rutes).

> üí° Recomanaci√≥: les m√©s r√†pides i estables solen ser les **unit√†ries** (serveis/repositories). Les **feature** s√≥n √∫tils per comprovar rutes, middleware i policies b√†siques.

---

## 6.1. Entorn de prova

### 6.1.1. `.env.testing`

Crea/edita **.env.testing**:

```env
APP_NAME=Laravel
APP_ENV=testing
APP_KEY=base64:MACjfdVeluYCiw5CvS5Za11P2iJ0AC43bsIpe7BzqQE=
APP_DEBUG=true
APP_URL=http://localhost

APP_LOCALE=ca
APP_FALLBACK_LOCALE=en
APP_FAKER_LOCALE=en_US

# BD de tests (sqlite en mem√≤ria)
DB_CONNECTION=sqlite
DB_DATABASE=:memory:

# Tot ‚Äúvol√†til‚Äù per a tests
CACHE_STORE=array
SESSION_DRIVER=array
QUEUE_CONNECTION=sync
MAIL_MAILER=array

# Per accelerar hashing als tests
BCRYPT_ROUNDS=4

LOG_CHANNEL=stack
LOG_STACK=single
LOG_LEVEL=warning

FILESYSTEM_DISK=local
```

### 6.1.2. `phpunit.xml`

Edita **phpunit.xml** (o crea‚Äôl) i fixa les variables d‚Äôentorn per a testing:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Unit">
            <directory>tests/Unit</directory>
        </testsuite>
        <testsuite name="Feature">
            <directory>tests/Feature</directory>
        </testsuite>
    </testsuites>

    <source>
        <include>
            <directory>app</directory>
        </include>
    </source>

    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="APP_MAINTENANCE_DRIVER" value="file"/>

        <!-- ‚úÖ CHANGED: BD de proves -->
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>

        <!-- ‚úÖ CHANGED: Drivers vol√†tils i rapidesa -->
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="CACHE_STORE" value="array"/>
        <env name="MAIL_MAILER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        <env name="SESSION_DRIVER" value="array"/>

        <!-- ‚úÖ CHANGED: Opt-out de perf/debug en test -->
        <env name="PULSE_ENABLED" value="false"/>
        <env name="TELESCOPE_ENABLED" value="false"/>
        <env name="NIGHTWATCH_ENABLED" value="false"/>

        <!-- (opcional per√≤ √∫til per URLs signades/verificaci√≥ email) -->
        <env name="APP_URL" value="http://localhost"/>
    </php>
</phpunit>
```

---

## 6.2. Crear els fitxers de test (amb Makefile)

Executa:

```bash
make artisan CMD="make:test EquipServiceTest --unit"
make artisan CMD="make:test EquipRepositoryTest --unit"
make artisan CMD="make:test EquipCrudFeatureTest"
```

Aix√≤ crear√†:

- `tests/Unit/EquipServiceTest.php`
- `tests/Unit/EquipRepositoryTest.php`
- `tests/Feature/EquipCrudFeatureTest.php`

---

## 6.3. Tests unit√†ries: `EquipServiceTest.php`

Fitxer: `tests/Unit/EquipServiceTest.php`

> üéØ Objectiu: provar la l√≤gica del servei (guardar/actualitzar/eliminar) sense rutes ni vistes.

**IMPORTANT (Mockery):** afegim `tearDown()` per evitar avisos i tancar Mockery. ‚úÖ

```php
<?php

namespace Tests\Unit;

use App\Models\Equip;
use App\Services\EquipService;
use Illuminate\Foundation\Testing\WithFaker;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;
use Mockery;
use Tests\TestCase;
use App\Repositories\BaseRepository;

class EquipServiceTest extends TestCase
{
    use WithFaker;

    // ‚úÖ CHANGED: tancar Mockery per evitar warnings
    protected function tearDown(): void
    {
        Mockery::close();
        parent::tearDown();
    }

    public function test_guardar_crea_equip_i_puja_escut_si_cal()
    {
        Storage::fake('public');

        $repo = Mockery::mock(BaseRepository::class);

        $data = ['nom' => 'FC Barcelona', 'titols' => 30];
        $escut = UploadedFile::fake()->image('escut.png', 200, 200);

        // ‚úÖ CHANGED: retornem un Equip amb el path real d‚Äôescut per poder assertExists correctament
        $repo->shouldReceive('create')
            ->once()
            ->with(Mockery::on(function ($payload) {
                return isset($payload['escut']) && str_starts_with($payload['escut'], 'escuts/');
            }))
            ->andReturnUsing(function ($payload) use ($data) {
                return new Equip(array_merge($data, ['escut' => $payload['escut']]));
            });

        $service = new EquipService($repo);
        $equip = $service->guardar($data, $escut);

        // ‚úÖ CHANGED: comprovem el fitxer exactament
        Storage::disk('public')->assertExists($equip->escut);
    }

    public function test_actualitzar_sustitueix_escut_i_esborra_l_antic()
    {
        Storage::fake('public');

        $repo = Mockery::mock(BaseRepository::class);
        $equip = new Equip(['id' => 1, 'nom' => 'Bar√ßa', 'escut' => 'escuts/vell.png']);

        // fitxer antic simulat
        Storage::disk('public')->put($equip->escut, 'dummy');

        $repo->shouldReceive('find')->once()->with(1)->andReturn($equip);
        $repo->shouldReceive('update')
            ->once()
            ->with(1, Mockery::on(fn($payload) => isset($payload['escut']) && str_starts_with($payload['escut'], 'escuts/')))
            ->andReturn($equip);

        $service = new EquipService($repo);
        $nouEscut = UploadedFile::fake()->image('nou.png');

        $service->actualitzar(1, ['nom' => 'Bar√ßa'], $nouEscut);

        // antic esborrat
        Storage::disk('public')->assertMissing('escuts/vell.png');
    }

    public function test_eliminar_esborra_escut_si_existeix()
    {
        Storage::fake('public');

        $repo = Mockery::mock(BaseRepository::class);
        $equip = new Equip(['id' => 2, 'escut' => 'escuts/logo.png']);
        Storage::disk('public')->put($equip->escut, 'dummy');

        $repo->shouldReceive('find')->once()->with(2)->andReturn($equip);
        $repo->shouldReceive('delete')->once()->with(2);

        $service = new EquipService($repo);
        $service->eliminar(2);

        Storage::disk('public')->assertMissing('escuts/logo.png');
    }
}
```

---

## 6.4. Test feature: `EquipCrudFeatureTest.php`

Fitxer: `tests/Feature/EquipCrudFeatureTest.php`

> üéØ Objectiu: comprovar que les **rutes** responen i el CRUD b√†sic funciona (amb BD de testing).

**NOTA:** ac√≠ fem `Gate::before()` per autoritzar-ho tot i no barallar-nos amb policies en aquesta pr√†ctica. ‚úÖ

```php
<?php

namespace Tests\Feature;

use App\Models\Equip;
use App\Models\Estadi;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Gate;
use Illuminate\Support\Facades\Storage;
use Illuminate\Http\UploadedFile;
use Tests\TestCase;

class EquipCrudFeatureTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();

        // ‚úÖ CHANGED: autoritza tot en tests per simplificar (policies/gates)
        Gate::before(function () { return true; });
    }

    public function test_es_pot_llistar_equips()
    {
        $u = User::factory()->create();
        $this->actingAs($u);

        Equip::factory()->create(['nom' => 'FC Barcelona']);
        Equip::factory()->create(['nom' => 'Real Madrid']);

        $resp = $this->get('/equips');
        $resp->assertStatus(200);
        $resp->assertSee('FC Barcelona');
        $resp->assertSee('Real Madrid');
    }

    public function test_es_pot_crear_un_equip()
    {
        $u = User::factory()->create([
            'role' => 'administrador',
            'email_verified_at' => now(),
        ]);
        $this->actingAs($u);

        $estadi = Estadi::factory()->create();
        Storage::fake('public');

        $resp = $this->from(route('equips.create'))
            ->post('/equips', [
                'nom' => 'FC Barcelona',
                'titols' => 30,
                'estadi_id' => $estadi->id,
                'escut' => UploadedFile::fake()->image('escut.png'),
            ]);

        $resp->assertSessionHasNoErrors();
        $resp->assertRedirect(route('equips.index'));

        $this->assertDatabaseHas('equips', [
            'nom' => 'FC Barcelona',
            'titols' => 30,
            'estadi_id' => $estadi->id,
        ]);
    }

    public function test_es_pot_actualitzar_un_equip()
    {
        $u = User::factory()->create([
            'role' => 'manager',
            'email_verified_at' => now(),
        ]);
        $this->actingAs($u);

        $estadi = Estadi::factory()->create();
        $equip = Equip::factory()->create([
            'nom' => 'FC Barcelona',
            'estadi_id' => $estadi->id,
            'titols' => 30,
        ]);

        $resp = $this->from(route('equips.edit', $equip))
            ->put("/equips/{$equip->id}", [
                'nom' => 'Bar√ßa',
                'estadi_id' => $estadi->id,
                'titols' => 31,
            ]);

        $resp->assertSessionHasNoErrors();
        $resp->assertRedirect(route('equips.index'));

        $this->assertDatabaseHas('equips', [
            'id' => $equip->id,
            'nom' => 'Bar√ßa',
             'titols' => 31,
        ]);
    }

    public function test_es_pot_esborrar_un_equip()
    {
        $u = User::factory()->create([
            'role' => 'administrador',
            'email_verified_at' => now(),
        ]);
        $this->actingAs($u);

        $equip = Equip::factory()->create(['nom' => 'FC Barcelona']);

        $resp = $this->from(route('equips.index'))->delete("/equips/{$equip->id}");

        $resp->assertSessionHasNoErrors();
        $resp->assertRedirect(route('equips.index'));

        $this->assertDatabaseMissing('equips', ['id' => $equip->id]);
    }
}
```

---

## 6.5. Tests unit√†ries: `EquipRepositoryTest.php`

Fitxer: `tests/Unit/EquipRepositoryTest.php`

> üéØ Objectiu: comprovar el repositori amb BD real de testing (sqlite en mem√≤ria) i `RefreshDatabase`.

```php
<?php

namespace Tests\Unit;

use App\Models\Equip;
use App\Models\Estadi;
use App\Repositories\EquipRepository;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class EquipRepositoryTest extends TestCase
{
    use RefreshDatabase;

    protected EquipRepository $repo;

    protected function setUp(): void
    {
        parent::setUp();
        $this->repo = new EquipRepository();
    }

    public function test_create_i_find()
    {
        $estadi = Estadi::factory()->create();

        $equip = $this->repo->create([
            'nom' => 'Valencia CF',
            'titols' => 6,
            'estadi_id' => $estadi->id,
        ]);

        $this->assertDatabaseHas('equips', ['nom' => 'Valencia CF']);
        $this->assertEquals('Valencia CF', $this->repo->find($equip->id)->nom);
    }

    public function test_update_modifica_un_equip()
    {
        $equip = Equip::factory()->create(['nom' => 'Antic']);

        $this->repo->update($equip->id, ['nom' => 'Nou']);

        $this->assertDatabaseHas('equips', ['id' => $equip->id, 'nom' => 'Nou']);
    }

    public function test_delete_esborra_un_equip()
    {
        $equip = Equip::factory()->create();

        $this->repo->delete($equip->id);

        $this->assertDatabaseMissing('equips', ['id' => $equip->id]);
    }

    public function test_getAll_retorna_tots()
    {
        Equip::factory()->count(3)->create();

        $equips = $this->repo->getAll();

        $this->assertCount(3, $equips);
    }
}
```

---

## 6.6. Executar els tests (amb Makefile)

### Executar-ho tot
```bash
make artisan CMD="test"
```

### Nom√©s Unit
```bash
make artisan CMD="test --testsuite=Unit"
```

### Nom√©s Feature
```bash
make artisan CMD="test --testsuite=Feature"
```

### Executar un test concret
```bash
make artisan CMD="test --filter=EquipServiceTest"
make artisan CMD="test --filter=EquipRepositoryTest"
make artisan CMD="test --filter=EquipCrudFeatureTest"
```

---

## 6.7. Errors t√≠pics (i solucions r√†pides)

- **Falla ‚Äúfactory not found‚Äù** ‚Üí assegura‚Äôt que tens `EquipFactory`, `EstadiFactory`, `UserFactory`.
- **Falla ‚Äúrole‚Äù en User** ‚Üí la teua taula `users` ha de tindre camp `role` (o adapta els tests al teu camp real).
- **Validaci√≥ required** (ex. `titols` required en update) ‚Üí envia eixe camp en el `put()`.
- **No canvia disc Storage** ‚Üí usa sempre `Storage::fake('public')` si el teu codi usa `disk('public')`.

---
